<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Feedback Dashboard - Î•Ï†ÏÏÎ± Chatbot</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    /* --- Î£Î¤Î¥Î› (Î”Î¹Î±Ï„Î·ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Dark Theme Ï€Î¿Ï… ÏƒÎ¿Ï… Î±ÏÎ­ÏƒÎµÎ¹) --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a1929 0%, #1a2332 100%);
      color: #e3e8ef;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container { max-width: 1600px; margin: 0 auto; }
    
    /* Header */
    header {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }

    .header-actions { display: flex; gap: 12px; }
    
    .btn {
      padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s;
    }
    .btn-refresh { background: #3b82f6; }
    .btn-refresh:hover { background: #2563eb; }
    .btn-export { background: #10b981; }
    .btn-export:hover { background: #059669; }
    .btn-danger { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }
    .btn-danger:hover { background: rgba(239,68,68,0.3); }

    /* Stats Grid (Î¤Î± Ï€Î¬Î½Ï‰ ÎºÎ¿Ï…Ï„Î¬ÎºÎ¹Î±) */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; padding: 20px;
    }
    .stat-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }
    .stat-val { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
    .stat-sub { font-size: 11px; color: #64748b; }

    /* Charts Row */
    .charts-row {
      display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;
    }
    @media(max-width: 1000px) { .charts-row { grid-template-columns: 1fr; } }
    
    .chart-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; padding: 20px; height: 350px;
    }
    .chart-container h2 { font-size: 18px; margin-bottom: 15px; color: #e2e8f0; }

    /* Insights Row (Top Questions etc) */
    .insights-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;
    }
    .insight-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; padding: 20px;
    }
    .insight-card h3 { font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .insight-list { list-style: none; }
    .insight-list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; display: flex; justify-content: space-between; }
    
    /* Tables */
    .section-title { font-size: 20px; margin: 40px 0 15px; border-left: 4px solid #3b82f6; padding-left: 15px; }
    .table-container { 
      background: rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; 
      border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
    }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: rgba(0,0,0,0.2); text-align: left; padding: 15px; font-size: 12px; text-transform: uppercase; color: #94a3b8; }
    td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; vertical-align: top;}
    tr:hover { background: rgba(255,255,255,0.02); }
    
    .q-cell { text-align: center; color: #3b82f6; font-weight: bold; }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
    .badge-pos { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge-neg { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* Pagination Controls */
    .pagination { display: flex; justify-content: flex-end; align-items: center; padding: 15px; gap: 15px; background: rgba(0,0,0,0.2); }
    .page-info { font-size: 14px; color: #94a3b8; }
    .page-btn { padding: 6px 12px; background: #334155; border: none; color: white; border-radius: 6px; cursor: pointer; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-btn:hover:not(:disabled) { background: #475569; }

  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>ğŸ¤– Ephyra Dashboard</h1>
    <div class="header-actions">
      <button class="btn btn-refresh" onclick="refreshAll()">ğŸ”„ Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
      <button class="btn btn-export" onclick="exportData()">ğŸ“¥ Export CSV</button>
      <button class="btn btn-danger" onclick="clearAllFeedback()">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Î£Ï…Î½Î¿Î»Î¹ÎºÎ± Feedback</div>
      <div class="stat-val" id="totalFeedback">-</div>
      <div class="stat-sub">ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Satisfaction Rate</div>
      <div class="stat-val" style="color:#3b82f6" id="satisfactionRate">-</div>
      <div class="stat-sub" id="sentimentTrend">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Î˜ÎµÏ„Î¹ÎºÎ± ğŸ‘</div>
      <div class="stat-val" style="color:#10b981" id="positiveFeedback">-</div>
      <div class="stat-sub" id="positivePercent">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Î‘ÏÎ½Î·Ï„Î¹ÎºÎ± ğŸ‘</div>
      <div class="stat-val" style="color:#ef4444" id="negativeFeedback">-</div>
      <div class="stat-sub" id="negativePercent">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ÎœÎ¿Î½Î±Î´Î¹ÎºÎ¿Î¹ Î§ÏÎ·ÏƒÏ„ÎµÏ‚</div>
      <div class="stat-val" id="uniqueUsers">-</div>
      <div class="stat-sub">Î’Î¬ÏƒÎµÎ¹ IP</div>
    </div>
  </div>

  <div class="charts-row">
    <div class="chart-container">
      <h2>ğŸ“ˆ Î¤Î¬ÏƒÎ· Feedback (30 Î—Î¼Î­ÏÎµÏ‚)</h2>
      <canvas id="feedbackChart"></canvas>
    </div>
    <div class="chart-container">
      <h2>ğŸ—£ï¸ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î“Î»ÏÏƒÏƒÎ±Ï‚</h2>
      <canvas id="languageChart"></canvas>
    </div>
  </div>

  <div class="insights-row">
    <div class="insight-card">
      <h3>â“ Top Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚</h3>
      <ul class="insight-list" id="topQuestionsList">
        <li>Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</li>
      </ul>
    </div>
    </div>

  <h2 class="section-title">ğŸ’¬ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î£Ï…Î½Î¿Î¼Î¹Î»Î¹ÏÎ½ (Chat)</h2>
  <div class="table-container">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
            <th>Î•ÏÏÏ„Î·ÏƒÎ·</th>
            <th>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·</th>
            <th>Feedback</th>
          </tr>
        </thead>
        <tbody id="chatTableBody">
          <tr><td colspan="5" style="text-align:center; padding:20px;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination">
        <span class="page-info" id="chatPageInfo">Î£ÎµÎ»Î¯Î´Î± 1</span>
        <div>
            <button class="page-btn" onclick="prevChatPage()">â¬…ï¸ Î ÏÎ¿Î·Î³.</button>
            <button class="page-btn" onclick="nextChatPage()">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿ â¡ï¸</button>
        </div>
    </div>
  </div>

  <h2 class="section-title">ğŸ“‹ Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Î•ÏÏ‰Ï„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï… (Survey)</h2>
  <div class="table-container">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Î£ÎµÎ½Î¬ÏÎ¹Î±</th>
            <th>Î¦ÏÎ»Î¿</th>
            <th>Î—Î»Î¹ÎºÎ¯Î±</th>

            <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Q5</th>
            <th>Q6</th><th>Q7</th><th>Q8</th><th>Q9</th><th>Q10</th>
            <th>Q11</th><th>Q12</th><th>Q13</th><th>Q14</th><th>Q15</th>
            <th>Q16</th>
            
          </tr>
        </thead>
        <tbody id="surveyTableBody">
          <tr><td colspan="18" style="text-align:center; padding:20px;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="pagination">
        <span class="page-info" id="surveyPageInfo">Î£ÎµÎ»Î¯Î´Î± 1</span>
        <div>
            <button class="page-btn" onclick="prevSurveyPage()">â¬…ï¸ Î ÏÎ¿Î·Î³.</button>
            <button class="page-btn" onclick="nextSurveyPage()">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿ â¡ï¸</button>
        </div>
    </div>
  </div>

</div>

<script>
  const API_URL = ""; 
  const ROWS_PER_PAGE = 10;
  
  // ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Î³Î¹Î± Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎºÎ±Î¹ Ï„Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î±
  let allChatData = [];
  let currentChatPage = 1;

  let allSurveyData = [];
  let currentSurveyPage = 1;

  let feedbackChartInstance = null;
  let languageChartInstance = null;

  // --- 1. Î¦ÎŸÎ¡Î¤Î©Î£Î— DEÎ”ÎŸÎœÎ•ÎÎ©Î (CHAT & STATS) ---
  async function loadDashboardStats() {
    try {
      const res = await fetch(`${API_URL}/feedback/stats?detailed=true`);
      const data = await res.json();
      
      // A. Î“Î­Î¼Î¹ÏƒÎ¼Î± KPIs
      document.getElementById('totalFeedback').innerText = data.total_feedback || 0;
      document.getElementById('positiveFeedback').innerText = data.positive || 0;
      document.getElementById('negativeFeedback').innerText = data.negative || 0;
      document.getElementById('satisfactionRate').innerText = (data.satisfaction_rate || 0) + '%';
      document.getElementById('uniqueUsers').innerText = data.unique_users || 0;

      // Î Î¿ÏƒÎ¿ÏƒÏ„Î¬
      const total = data.total_feedback || 1;
      const posPct = Math.round((data.positive / total) * 100);
      const negPct = Math.round((data.negative / total) * 100);
      document.getElementById('positivePercent').innerText = posPct + '%';
      document.getElementById('negativePercent').innerText = negPct + '%';
      document.getElementById('sentimentTrend').innerText = data.sentiment_trend_percent || '-';

      // B. Top Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚
      const qList = document.getElementById('topQuestionsList');
      if(data.top_questions && data.top_questions.length > 0){
          qList.innerHTML = data.top_questions.map(q => 
              `<li><span>${q.question}</span> <strong>${q.count}</strong></li>`
          ).join('');
      } else {
          qList.innerHTML = '<li>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</li>';
      }

      // C. Î“ÏÎ±Ï†Î®Î¼Î±Ï„Î±
      renderCharts(data);

      // D. Chat Table & Pagination
      allChatData = data.recent_feedback || [];
      currentChatPage = 1;
      renderChatTable();

    } catch (e) {
      console.error("Stats Error:", e);
    }
  }

  // --- 2. Î¦ÎŸÎ¡Î¤Î©Î£Î— Î”Î•Î”ÎŸÎœÎ•ÎÎ©Î (SURVEY) ---
  async function loadSurveyResults() {
    try {
      const res = await fetch(`${API_URL}/survey_results`);
      const data = await res.json();
      
      allSurveyData = data || [];
      currentSurveyPage = 1;
      renderSurveyTable();

    } catch (e) {
      console.error("Survey Error:", e);
    }
  }

  // --- 3. RENDER CHAT TABLE (Î¼Îµ ÏƒÎµÎ»Î¯Î´ÎµÏ‚) ---
  // --- 3. RENDER CHAT TABLE (Î”Î™ÎŸÎ¡Î˜Î©ÎœÎ•ÎÎŸ) ---
  function renderChatTable() {
      const tbody = document.getElementById('chatTableBody');
      const start = (currentChatPage - 1) * ROWS_PER_PAGE;
      const end = start + ROWS_PER_PAGE;
      const pageData = allChatData.slice(start, end);
      const totalPages = Math.ceil(allChatData.length / ROWS_PER_PAGE) || 1;

      document.getElementById('chatPageInfo').innerText = `Î£ÎµÎ»Î¯Î´Î± ${currentChatPage} Î±Ï€ÏŒ ${totalPages} (Î£ÏÎ½Î¿Î»Î¿: ${allChatData.length})`;

      if(pageData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</td></tr>';
          return;
      }

      tbody.innerHTML = pageData.map(item => `
        <tr>
          <td>#${item.id}</td>
          <td style="font-size:11px; white-space:nowrap;">
            ${item.timestamp ? item.timestamp.replace('T', ' ').split('.')[0] : '-'}
          </td>
          
          <td style="font-size:13px; max-width: 250px; overflow: hidden; text-overflow: ellipsis;">
            ${item.user_question || '-'}
          </td>

          <td style="font-size:13px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; color: #a0aec0;">
            ${item.bot_response || '-'}
          </td>

          <td>
            ${item.is_positive 
              ? '<span class="badge badge-pos">ğŸ‘ Î˜ÎµÏ„Î¹ÎºÏŒ</span>' 
              : '<span class="badge badge-neg">ğŸ‘ Î‘ÏÎ½Î·Ï„Î¹ÎºÏŒ</span>'}
          </td>
        </tr>
      `).join('');
  }
  // --- 4. RENDER SURVEY TABLE (Î¼Îµ ÏƒÎµÎ»Î¯Î´ÎµÏ‚) ---
  // --- 4. RENDER SURVEY TABLE (Î”Î™ÎŸÎ¡Î˜Î©ÎœÎ•ÎÎŸ ÎœÎ• Î¦Î¥Î›ÎŸ/Î—Î›Î™ÎšÎ™Î‘/Q16) ---
 
  function renderSurveyTable() {
    const tbody = document.getElementById('surveyTableBody');
    const start = (currentSurveyPage - 1) * ROWS_PER_PAGE;
    const end = start + ROWS_PER_PAGE;
    const pageData = allSurveyData.slice(start, end);
    const totalPages = Math.ceil(allSurveyData.length / ROWS_PER_PAGE) || 1;

    document.getElementById('surveyPageInfo').innerText = `Î£ÎµÎ»Î¯Î´Î± ${currentSurveyPage} Î±Ï€ÏŒ ${totalPages} (Î£ÏÎ½Î¿Î»Î¿: ${allSurveyData.length})`;

    if(pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="22" style="text-align:center; padding:20px;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</td></tr>';
        return;
    }

    tbody.innerHTML = pageData.map(item => `
        <tr>
          <td>#${item.id}</td>
          <td style="font-size:11px">${item.timestamp ? item.timestamp.replace('T', ' ').split('.')[0] : '-'}</td>
          
          <td style="font-weight:500; color:#ffd700;">${item.scenarios_tested || item.scenarios || '-'}</td>
          
          <td style="font-size:12px">${item.gender || '-'}</td>
          <td style="font-size:12px">${item.age || '-'}</td>

          <td class="q-cell">${item.q1||'-'}</td><td class="q-cell">${item.q2||'-'}</td>
          <td class="q-cell">${item.q3||'-'}</td><td class="q-cell">${item.q4||'-'}</td>
          <td class="q-cell">${item.q5||'-'}</td><td class="q-cell">${item.q6||'-'}</td>
          <td class="q-cell">${item.q7||'-'}</td><td class="q-cell">${item.q8||'-'}</td>
          <td class="q-cell">${item.q9||'-'}</td><td class="q-cell">${item.q10||'-'}</td>
          <td class="q-cell">${item.q11||'-'}</td><td class="q-cell">${item.q12||'-'}</td>
          <td class="q-cell">${item.q13||'-'}</td><td class="q-cell">${item.q14||'-'}</td>
          <td class="q-cell">${item.q15||'-'}</td>
          
          <td class="q-cell" style="font-weight:bold; color:#1e90ff;">${item.q16 || '-'}</td>
        </tr>
      `).join('');
}

  // --- 5. PAGINATION CONTROLS ---
  function prevChatPage() { if(currentChatPage > 1) { currentChatPage--; renderChatTable(); } }
  function nextChatPage() { 
      const totalPages = Math.ceil(allChatData.length / ROWS_PER_PAGE);
      if(currentChatPage < totalPages) { currentChatPage++; renderChatTable(); } 
  }

  function prevSurveyPage() { if(currentSurveyPage > 1) { currentSurveyPage--; renderSurveyTable(); } }
  function nextSurveyPage() { 
      const totalPages = Math.ceil(allSurveyData.length / ROWS_PER_PAGE);
      if(currentSurveyPage < totalPages) { currentSurveyPage++; renderSurveyTable(); } 
  }

  // --- 6. CHARTS ---
  function renderCharts(data) {
    // A. Trend Chart
    const ctxTrend = document.getElementById('feedbackChart');
    if(ctxTrend) {
      if(feedbackChartInstance) feedbackChartInstance.destroy();
      const dates = data.daily_data ? data.daily_data.map(d => d.date) : [];
      const counts = data.daily_data ? data.daily_data.map(d => d.count) : [];

      feedbackChartInstance = new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Feedback',
            data: counts,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: { 
          responsive: true, 
          plugins: { legend: {display:false} }, 
          scales: { 
            x: {grid: {display:false}, ticks:{color:'#94a3b8'}}, 
            y: {beginAtZero: true, grid: {color:'rgba(255,255,255,0.05)'}, ticks:{color:'#94a3b8'}}
          } 
        }
      });
    }

    // B. Language Chart
    const ctxLang = document.getElementById('languageChart');
    if(ctxLang) {
      if(languageChartInstance) languageChartInstance.destroy();
      const el = data.language_distribution?.el || 0;
      const en = data.language_distribution?.en || 0;

      languageChartInstance = new Chart(ctxLang, {
        type: 'doughnut',
        data: {
          labels: ['Î•Î»Î»Î·Î½Î¹ÎºÎ¬', 'English'],
          datasets: [{ data: [el, en], backgroundColor: ['#3b82f6', '#10b981'], borderWidth: 0 }]
        },
        options: { responsive: true, plugins: { legend: {position:'bottom', labels:{color:'#fff'}} } }
      });
    }
  }

  // --- 7. BUTTON ACTIONS ---
  function refreshAll() { loadDashboardStats(); loadSurveyResults(); }
  
  function exportData() { window.location.href = `${API_URL}/feedback/export?format=csv`; }
  
  async function clearAllFeedback() {
    if(!confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î˜Î­Î»ÎµÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ CHAT; (Î”ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î¿ ÎµÏÏ‰Ï„Î·Î¼Î±Ï„Î¿Î»ÏŒÎ³Î¹Î¿)")) return;
    try {
      const res = await fetch(`${API_URL}/feedback/clear`, { method: 'POST' });
      const result = await res.json();
      if(result.status === 'success') { alert("âœ… Î”Î¹Î±Î³ÏÎ±Ï†Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ."); refreshAll(); }
    } catch(e) { alert("âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚."); }
  }

  // --- START ---
  refreshAll();
  setInterval(refreshAll, 30000); // Auto-refresh ÎºÎ¬Î¸Îµ 30 Î´ÎµÏ…Ï„.

</script>

</body>
</html>